- name: valid log policy
  sane_as:
    - http://determined.ai/schemas/expconf/v0/log-policy.json
  case:
    pattern: a
    actions:
      - signal: sig
      - cancel_retries
      - exclude_node

- name: log policy is invalid with both action and actions
  sanity_errors:
    http://determined.ai/schemas/expconf/v0/log-policy.json:
      - "<config>: both the depreated \"action\" field and the newer \"actions\" field are detected"
  case:
    pattern: a
    actions:
      - signal: sig
    action:
      type: cancel_retries

- name: invalid log policy 1
  sanity_errors:
    http://determined.ai/schemas/expconf/v0/log-policy.json:
      - "expect one of the followings: cancel_retries, exclude_node, or an object with a single \"signal\" field"
  case:
    pattern: a
    actions:
      - notallowedstring

- name: invalid log policy 2
  sanity_errors:
    http://determined.ai/schemas/expconf/v0/log-policy.json:
      - "expect one of the followings: cancel_retries, exclude_node, or an object with a single \"signal\" field"
  case:
    pattern: a
    actions:
      - notallowedstring

- name: invalid log policy 3
  sanity_errors:
    http://determined.ai/schemas/expconf/v0/log-policy.json:
      - "expect one of the followings: cancel_retries, exclude_node, or an object with a single \"signal\" field"
  case:
    pattern: a
    actions:
      - 3

- name: unique actions when merged
  merge_as: http://determined.ai/schemas/expconf/v0/log-policies.json
  case:
    - pattern: a
      actions:
        - cancel_retries
  merge_src:
    - pattern: a
      actions:
        - exclude_node
  merged:
    - pattern: a
      actions:
        - cancel_retries
        - exclude_node

- name: no duplicated actions when merged
  merge_as: http://determined.ai/schemas/expconf/v0/log-policies.json
  case:
    - pattern: a
      actions:
        - cancel_retries
        - exclude_node
  merge_src:
    - pattern: a
      actions:
        - exclude_node
  merged:
    - pattern: a
      actions:
        - cancel_retries
        - exclude_node

- name: no duplicated actions when merged 2
  merge_as: http://determined.ai/schemas/expconf/v0/log-policies.json
  case:
    - pattern: a
      actions:
        - exclude_node
  merge_src:
    - pattern: a
      actions:
        - cancel_retries
        - exclude_node
  merged:
    - pattern: a
      actions:
        - cancel_retries
        - exclude_node

- name: user can override default values
  sane_as:
    - http://determined.ai/schemas/expconf/v0/log-policies.json
  default_as:
    http://determined.ai/schemas/expconf/v0/log-policies.json
  case: []
  defaulted: []

- name: log action cancel_retries
  sane_as:
    - http://determined.ai/schemas/expconf/v0/log-legacy-action-cancel-retries.json
  case:
    type: cancel_retries

- name: log action exclude_node
  sane_as:
    - http://determined.ai/schemas/expconf/v0/log-legacy-action-exclude-node.json
  case:
    type: exclude_node

- name: recognize action field for backward compatibility
  merge_as: http://determined.ai/schemas/expconf/v0/log-policies.json
  case: []
  merge_src:
    - pattern: a
      action:
        type: cancel_retries
    - pattern: a
      action:
        type: exclude_node
    - pattern: b
      action:
        type: exclude_node
  merged:
    - pattern: a
      actions:
        - cancel_retries
        - exclude_node
    - pattern: b
      actions:
        - exclude_node
