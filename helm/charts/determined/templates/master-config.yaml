apiVersion: v1
kind: ConfigMap
metadata:
   name: determined-master-config-{{ .Release.Name }}
   namespace: {{ .Release.Namespace }}
   labels:
     app: determined-master-{{ .Release.Name }}
     release: {{ .Release.Name }}
data:
  master.yaml: |
    checkpoint_storage:
      type: {{ required "A valid Values.checkpointStorage.type entry is required!" .Values.checkpointStorage.type | quote}}
      {{- if eq .Values.checkpointStorage.type "shared_fs" }}
      host_path: {{ required "A valid Values.checkpointStorage.hostPath entry is required!" .Values.checkpointStorage.hostPath | quote }}
      {{- else if eq .Values.checkpointStorage.type "gcs" }}
      bucket: {{ required "A valid Values.checkpointStorage.bucket entry is required!" .Values.checkpointStorage.bucket }}
      prefix: {{ .Values.checkpointStorage.prefix | quote }}
      {{- else if eq .Values.checkpointStorage.type "s3" }}
      bucket: {{ .Values.s3.bucket }}
      access_key: {{ .Values.s3.accessKey }}
      secret_key: {{ .Values.s3.secretKey }}
      endpoint_url: https://object.{{ .Values.s3.region | lower }}.coreweave.com
      prefix: {{ .Values.checkpointStorage.prefix | quote }}
      {{- else if eq .Values.checkpointStorage.type "azure" }}
      {{- if and .Values.checkpointStorage.connection_string .Values.checkpointStorage.account_url }}
      {{ required "Exactly one of .Values.checkpointStorage.connection_string or .Values.checkpointStorage.account_url must be specified!" "" }}
      {{- else if and .Values.checkpointStorage.connection_string .Values.checkpointStorage.credential }}
      {{ required ".Values.checkpointStorage.connection_string and .Values.checkpointStorage.credential must not both be specified!" "" }}
      {{- else }}
      container: {{ required "A valid Values.checkpointStorage.container entry is required!" .Values.checkpointStorage.container }}
      connection_string: {{ .Values.checkpointStorage.connection_string }}
      account_url: {{ .Values.checkpointStorage.account_url }}
      credential: {{ .Values.checkpointStorage.credential }}
      {{- end }}
      {{- end }}
      save_experiment_best: {{ .Values.checkpointStorage.saveExperimentBest | default 0 }}
      save_trial_best: {{ .Values.checkpointStorage.saveTrialBest | default 1 }}
      save_trial_latest: {{ .Values.checkpointStorage.saveTrialLatest | default 1 }}

    db:
      user: {{ required "A valid Values.db.user entry required!" .Values.db.user | quote }}
      password: {{ required "A valid Values.db.password entry required!" .Values.db.password | quote }}
      {{- if .Values.db.hostAddress }}
      host: {{ .Values.db.hostAddress }}
      {{- else }}
      host: determined-db-service-{{ .Release.Name }}
      {{- end  }}
      port: {{ .Values.db.port }}
      name: {{ .Values.db.name | quote }}
      {{- if .Values.db.sslMode }}
      ssl_mode: {{ .Values.db.sslMode }}
      {{- $rootCert := (required "A valid .Values.db.sslRootCert entry required!" .Values.db.sslRootCert )}}
      ssl_root_cert: {{ include "determined.secretPath" . }}{{ $rootCert }}
      {{- end }}

    {{- if .Values.tlsSecret }}
    security:
      tls:
        cert: {{ include "determined.secretPath" . }}tls.crt
        key: {{ include "determined.secretPath" . }}tls.key
    {{ end }}
    port: {{ include "determined.masterPort" . }}

    resource_manager:
      type: "kubernetes"
      namespace: {{ .Release.Namespace }}
      max_slots_per_pod: {{ required "A valid Values.maxSlotsPerPod entry is required!" .Values.maxSlotsPerPod }}
      master_service_name: determined-master-service-{{ .Release.Name }}
      {{- if .Values.defaultScheduler}}
      {{- $schedulerType := .Values.defaultScheduler | trim}}
      {{- if or (eq $schedulerType "coscheduler") (eq $schedulerType "preemption")}}
      default_scheduler: {{ $schedulerType }}
      {{- end }}
      {{- end }}
      {{- if (ne (default "gpu" .Values.slotType) "gpu") }}
      slot_type: {{ .Values.slotType }}
      slot_resource_requests:
        cpu: {{ .Values.slotResourceRequests.cpu }}
      {{- end }}
      {{- if .Values.fluent }}
      fluent:
        {{- if .Values.fluent.image }}
        image: {{ .Values.fluent.image }}
        {{- end }}
      {{- end }}
      default_aux_resource_pool: cpu_pool
      default_compute_resource_pool: {{ .Values.resources.resourcePool }}

    {{$cpuImage := (split "/" "determinedai/environments:py-3.8-pytorch-1.10-lightning-1.5-tf-2.8-cpu-3e933ea")._1}}
    {{- $gpuImage := (split "/" "determinedai/environments:cuda-11.3-pytorch-1.10-lightning-1.5-tf-2.8-gpu-3e933ea")._1 -}}
    
    resource_pools:
      - pool_name: cpu_pool
        description: "Resource Pool for Shells & Commands."
        task_container_defaults:
          image:
            cpu: {{ .Values.imageRegistry }}/{{ $cpuImage }}
          cpu_pod_spec: {{ include "determined.cpuPodSpec" . | fromYaml | toJson }}
      - pool_name: RTX_A4000
        description: "Resource Pool for RTX_A4000"
        task_container_defaults:
          image:
            cpu: {{ .Values.imageRegistry }}/{{ $cpuImage }}
            gpu: {{ .Values.imageRegistry }}/{{ $gpuImage }}
          gpu_pod_spec: {{ include "determined.gpuPodSpecRTX_A4000" . | fromYaml | toJson }}
      - pool_name: RTX_A5000
        description: "Resource Pool for RTX_A5000"
        task_container_defaults:
          image:
            cpu: {{ .Values.imageRegistry }}/{{ $cpuImage }}
            gpu: {{ .Values.imageRegistry }}/{{ $gpuImage }}
          gpu_pod_spec: {{ include "determined.gpuPodSpecRTX_A5000" . | fromYaml | toJson }}
      - pool_name: A40
        description: "Resource Pool for A40"
        task_container_defaults:
          image:
            cpu: {{ .Values.imageRegistry }}/{{ $cpuImage }}
            gpu: {{ .Values.imageRegistry }}/{{ $gpuImage }}
          gpu_pod_spec: {{ include "determined.gpuPodSpecA40" . | fromYaml | toJson }}
    
    {{- if .Values.telemetry }}
    telemetry:
      enabled: {{ .Values.telemetry.enabled }}
    {{- end }}

    {{- if .Values.observability }}
    observability:
      enable_prometheus: {{ required "A valid .Values.observability.enable_prometheus must be provided if setting .Values.observability!" .Values.observability.enable_prometheus }}
    {{- end }}

    {{- if .Values.clusterName }}
    cluster_name: {{ .Values.clusterName }}
    {{- end }}

    {{- if .Values.logging }}
    logging:
      {{- if .Values.logging.type }}
      type: {{ .Values.logging.type }}
      {{- end }}

      {{- if (eq (default "" .Values.logging.type) "elastic") }}
      host: {{ required "A valid host must be provided if logging to Elasticsearch!" .Values.logging.host }}
      port: {{ required "A valid port must be provided if logging to Elasticsearch!" .Values.logging.port }}
      {{- if .Values.logging.security }}
      security:
        {{- if .Values.logging.security.username }}
        username: {{ .Values.logging.security.username }}
        {{- end }}
        {{- if .Values.logging.security.password }}
        password: {{ .Values.logging.security.password }}
        {{- end }}
        {{- if .Values.logging.security.tls }}
        tls:
          {{- if .Values.logging.security.tls.enabled }}
          enabled: {{ .Values.logging.security.tls.enabled }}
          {{- end }}
          {{- if .Values.logging.security.tls.skipVerify }}
          skip_verify: {{ .Values.logging.security.tls.skipVerify }}
          {{- end }}
          {{- if .Values.logging.security.tls.certificate }}
          certificate: /etc/determined/elastic.crt
          {{- end }}
          {{- if .Values.logging.security.tls.certificateName }}
          certificate_name: {{ .Values.logging.security.tls.certificateName }}
          {{- end }}
        {{- end}}
      {{- end }}
      {{- end }}
    {{- end}}
  {{- if .Values.logging }}
  {{- if .Values.logging.security }}
  {{- if .Values.logging.security.tls }}
  {{- if .Values.logging.security.tls.certificate }}
  elastic.crt: |{{ nindent 4 .Values.logging.security.tls.certificate }}
  {{- end }}
  {{- end }}
  {{- end }}
  {{- end }}
