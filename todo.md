# table partitioning

1 parent table: `metrics`
3 underlying tables: `raw_validation`, `raw_steps`, `generic_metrics`

- check partitions have the same constraints. `INHERITS`
- pick the partitioning scheme and type
  - list partitioning. on metric type
  - can we avoid adding an extra col? if not we can set default val during migration
    - ENUM type
  - is the current raw_validations and raw_steps scheme sufficient?
    - add `type` column. as ENUM w/ 3 values to start
- alter unique indexes on existing tables to include `type` and
add include in the new table.
- create the parent table `metrics`
- alter 2 existing tables to add partitioning
  - add a new col
  - define as a partition
- create a new `generic_metrics` table. define as a partition of `metrics`

TODO:
- [n] remove go references to raw_steps and raw_validations
- [x] no need to mess with underlying table ids: sequence on top table but we'd still have duplicates
- [x] update (or leave off) code directly working with the underlying tables
  `ag 'from .*(steps|validations)' master -l | grep -v migration`


metrics have test type. (test validation set)
0 w/ steps completed.


timing: 9s on latest-master db dump to run the migration and revert.
```
determined> SELECT
   'raw_validations' AS table_name,
   COUNT(*) AS total_rows,
   pg_size_pretty(pg_total_relation_size('raw_validations')) AS
  total_size
 FROM
   raw_validations
 UNION
 SELECT
   'raw_steps' AS table_name,
   COUNT(*) AS total_rows,
   pg_size_pretty(pg_total_relation_size('raw_steps')) AS total
 _size
 FROM
   raw_steps;
+-----------------+------------+------------+
| table_name      | total_rows | total_size |
|-----------------+------------+------------|
| raw_steps       | 1186745    | 1075 MB    |
| raw_validations | 81195      | 19 MB      |
+-----------------+------------+------------+
```

```
determined> \d raw_validations;
+---------------+--------------------------+--------------------------------------------+
| Column        | Type                     | Modifiers                                  |
|---------------+--------------------------+--------------------------------------------|
| id            | integer                  |  not null generated by default as identity |
| trial_id      | integer                  |  not null                                  |
| end_time      | timestamp with time zone |                                            |
| metrics       | jsonb                    |                                            |
| total_batches | integer                  |  not null default 0                        |
| trial_run_id  | integer                  |  not null default 0                        |
| archived      | boolean                  |  not null default false                    |
+---------------+--------------------------+--------------------------------------------+
Indexes:
    "validations_pkey" PRIMARY KEY, btree (id)
    "validations_trial_id_total_batches_run_id_unique" UNIQUE, btree (trial_id, total_batches, trial_run_id)
    "ix_validations_trial_id" btree (trial_id)
    "validations_archived" btree (archived)
Triggers:
    autoupdate_exp_validation_metrics_name AFTER INSERT ON raw_validations FOR EACH ROW EXECUTE FUNCTION autoupdate_exp_validation_metrics_name()

Time: 0.105s
determined> \d raw_steps;
+---------------+--------------------------+---------------------------------------------------------+
| Column        | Type                     | Modifiers                                               |
|---------------+--------------------------+---------------------------------------------------------|
| trial_id      | integer                  |  not null                                               |
| end_time      | timestamp with time zone |                                                         |
| metrics       | jsonb                    |                                                         |
| total_batches | integer                  |  not null default 0                                     |
| trial_run_id  | integer                  |  not null default 0                                     |
| archived      | boolean                  |  not null default false                                 |
| id            | integer                  |  not null default nextval('raw_steps_id_seq'::regclass) |
+---------------+--------------------------+---------------------------------------------------------+
Indexes:
    "steps_trial_id_total_batches_run_id_unique" UNIQUE, btree (trial_id, total_batches, trial_run_id)
    "steps_archived" btree (archived)
Foreign-key constraints:
    "steps_trial_id_fkey" FOREIGN KEY (trial_id) REFERENCES trials(id)

```


```sql
CREATE TYPE metric_type AS ENUM ('validation', 'training', 'generic');

ALTER TABLE raw_validations ADD COLUMN type metric_type NOT NULL DEFAULT 'validation';
ALTER INDEX validations_trial_id_total_batches_run_id_unique RENAME TO validations_trial_id_total_batches_run_id_unique_old;
CREATE UNIQUE INDEX validations_trial_id_total_batches_run_id_type_unique ON raw_validations (trial_id, total_batches, trial_run_id, type);
DROP INDEX validations_trial_id_total_batches_run_id_unique_old;

ALTER TABLE raw_steps ADD COLUMN type metric_type NOT NULL DEFAULT 'training';
ALTER INDEX steps_trial_id_total_batches_run_id_unique RENAME TO steps_trial_id_total_batches_run_id_unique_old;
CREATE UNIQUE INDEX steps_trial_id_total_batches_run_id_type_unique ON raw_steps (trial_id, total_batches, trial_run_id, type);
DROP INDEX steps_trial_id_total_batches_run_id_unique_old;

-- CREATE TABLE generic_metrics (
--   id SERIAL PRIMARY KEY,
--   trial_id INTEGER NOT NULL,
--   end_time TIMESTAMP WITH TIME ZONE NOT NULL,
--   type metric_type NOT NULL DEFAULT 'generic',
--   metrics JSONB NOT NULL,
--   total_batches INTEGER NOT NULL DEFAULT 0,
--   trial_run_id INTEGER NOT NULL DEFAULT 0,
--   archived BOOLEAN NOT NULL DEFAULT false,
--   CONSTRAINT trial_fk FOREIGN KEY (trial_id) REFERENCES trials(id)
-- );

CREATE TABLE generic_metrics (LIKE raw_steps INCLUDING ALL);
ALTER TABLE generic_metrics ALTER COLUMN type SET DEFAULT 'generic';

CREATE TABLE generic (LIKE generic_metrics INCLUDING ALL)
    PARTITION BY LIST (type);
-- CHECK make sure it has all the constraints set.


ALTER TABLE generic ATTACH PARTITION generic_metrics FOR VALUES IN ('generic');
ALTER TABLE generic ATTACH PARTITION raw_validations FOR VALUES IN ('validation');
ALTER TABLE generic ATTACH PARTITION raw_steps FOR VALUES IN ('training');
```
