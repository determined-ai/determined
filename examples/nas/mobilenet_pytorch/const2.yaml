# NOTE: this config uses randomly generated data on single GPU.
# Please use distributed.yaml if you want to run on the
# the actual imagenet data.
description: ofa_pytorch

data:
  # Change bucket_name to GCP bucket with imagenet dataset
  # Data folder structure assumed to be imagenet/train and 
  # imagenet/validation for the two data splits.
  #
  # If bucket_name is null, we will run with randomly 
  # generated data.
  bucket_name: determined-ai-datasets
  # We recommend num_workers_train to be set to 16
  # when running with slots_per_trial=8
  num_workers_train: 8
  num_workers_val: 8
  # If streaming is true, we will send request to bucket
  # every time an image is requested.  If false, we will
  # save data to disk and load that the next time the
  # image is requested.  We recommend streaming=true
  # to avoid having to mount directories to docker container 
  # and guarantee good performance regardless of disk speed.
  streaming: true
  # This folder is only used if streaming is false.
  # This should probably match the container_path
  # in a provided bind mount.
  data_download_dir: null

# Uncomment this if you want to mount a host directory to the 
# docker container.
#bind_mounts:
#  - host_path: /tmp
#    container_path: /mnt/data
#    read_only: false

min_validation_period:
  epochs: 1

hyperparameters:
  weights_from: null
  global_batch_size: 2048
  n_classes: 1000
  # Batch norm
  bn_momentum: 0.1
  bn_eps: 1e-5
  dropout: 0.1
  init_policy: he_fout
  label_smoothing_rate: 0.1
  weight_decay: 3e-5
  kd_ratio: 1. # Knowledge distillation ratio
  # Optimizer
  learning_rate: 0.96
  momentum: 0.9
  # Choices include linear and cosine
  lr_scheduler: cosine
  lr_epochs: 180
  warmup_epochs: 5
  b11_ks: 3
  b12_ks: 7
  b13_ks: 7
  b14_ks: 7
  b21_ks: 3
  b22_ks: 7
  b23_ks: 7
  b24_ks: 5
  b31_ks: 5
  b32_ks: 5
  b33_ks: 3
  b34_ks: 3
  b41_ks: 7
  b42_ks: 7
  b43_ks: 7
  b44_ks: 5
  b51_ks: 3
  b52_ks: 7
  b53_ks: 7
  b54_ks: 3
  b1_depth: 4
  b2_depth: 4
  b3_depth: 3
  b4_depth: 2
  b5_depth: 2
  b11_expand: 6
  b12_expand: 3
  b13_expand: 3
  b14_expand: 4
  b21_expand: 4
  b22_expand: 6
  b23_expand: 3
  b24_expand: 3
  b31_expand: 6
  b32_expand: 3
  b33_expand: 6
  b34_expand: 6
  b41_expand: 4
  b42_expand: 6
  b43_expand: 6
  b44_expand: 3
  b51_expand: 6
  b52_expand: 3
  b53_expand: 4
  b54_expand: 4

resources:
  # We recommend 8 slots with V100
  # and at least 16 slots with K80 GPUs.
  slots_per_trial: 32
  shm_size: 4000000000

records_per_epoch: 1281166
searcher:
  name: single
  metric: top1_accuracy 
  smaller_is_better: false 
  max_length:
    epochs: 360 # 1.2 million images in training set of imagenet

optimizations:
  aggregation_frequency:  1

entrypoint: model_inplace_distillation:OFATrial
