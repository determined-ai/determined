# This startup input will cause the harness to rebuild on startup.
startup_input: "p"

commands:
  p: |
    make -C bindings build && \
    make -C master stream-gen && \
    make -C harness clean build  # rebuild Python
  w: make -C bindings build && make -C webui build  # rebuild Webui
  c: make -C docs build  # rebuild doCs (capital C is the mnemonic)

# Three stages: db, master, and agent.
stages:
  - db:
      port: 5432
      db_name: determined
      password: postgres
      container_name: determined_db
      image_name: "postgres:10.14"

      # data_dir is where the persistent files will be saved to.  If this key
      # is not present, the database will not persist at all.
      data_dir: det-postgres

  - master:
      pre:
        - sh: make -C proto build
        - sh: make -C master build
        - sh: make -C tools prep-root
        - sh: mkdir -p /tmp/determined-cp
      post:
        - logcheck:
            regex: accepting incoming connections on port
      cmdline:
        - master/build/determined-master
        - --config-file
        - :config

      # config_file is just a master.yaml
      config_file:
        resource_manager:
          type: agent
          scheduler:
            type: fair_share
            fitting_policy: worst
          default_aux_resource_pool: pool1
          default_compute_resource_pool: pool1
        resource_pools:
          - pool_name: pool1
            scheduler:
              type: priority
              preemption: true
              fitting_policy: best
          - pool_name: pool2
            scheduler:
              type: priority
              fitting_policy: worst
        db:
          host: localhost
          port: 5432
          password: postgres
          user: postgres
          name: determined
        checkpoint_storage:
          type: shared_fs
          host_path: /tmp/determined-cp
        cache:
          cache_dir: /tmp/determined-cache
        log:
          level: debug
        logging:
          type: default
        retention_policy:
          log_retention_days: 7
          schedule: 60m
        enable_cors: true
        observability:
          enable_prometheus: true

        # This is important: we have to use the symbolic links in the
        # tools/build directory to run properly.
        root: tools/build
  - agent:
      # Each agent stage should have a unique name for devcluster.
      name: agent1
      pre:
        - sh: make -C agent build
      config_file:
        master_host: 127.0.0.1
        master_port: 8080
        slot_type: cuda
        visible_gpus: 0
        resource_pool: pool1
        container_master_host: $DOCKER_LOCALHOST
        # Often dtrain clusters have multiple gpus per agent.
        artificial_slots: 8
        # Each agent needs a unique agent_id.
        agent_id: agent1
        # Each agent needs a deconflicting fluent container
        fluent:
          port: 24224  # default value is 24224
          container_name: determined-fluent-1
  - agent:
      # Each agent stage should have a unique name for devcluster.
      name: agent2
      pre:
        - sh: make -C agent build
      config_file:
        master_host: 127.0.0.1
        master_port: 8080
        resource_pool: pool2
        container_master_host: $DOCKER_LOCALHOST
        # Often dtrain clusters have multiple gpus per agent.
        artificial_slots: 8
        # Each agent needs a unique agent_id.
        agent_id: agent2
        # Each agent needs a deconflicting fluent container
        fluent:
          port: 24225  # default value is 24224
          container_name: determined-fluent-2
