# This startup input will cause the harness to rebuild on startup.
startup_input: "p"

commands:
  p: make -C harness build        # rebuild Python
  w: make -C webui build          # rebuild Webui
  c: make -C docs build           # rebuild doCs

# Three stages: db, master, and agent.
stages:
  - db:
      port: 5431
      db_name: determined
      password: postgres
      container_name: determined_db
      image_name: "postgres:10.14"

      # data_dir is where the persistent files will be saved to.  If this key
      # is not present, the database will not persist at all.
      data_dir: ~/.postgres

  - master:
      pre:
        - sh: make -C proto build
        - sh: make -C master build
        - sh: make -C tools prep-root
        - sh: mkdir -p /tmp/determined-cp
      post:
        - logcheck:
            regex: accepting incoming connections on port
      cmdline:
        - master/build/determined-master
        - --config-file
        - :config

      # config_file is just a master.yaml
      config_file:
        port: 8081
        db:
          host: localhost
          port: 5431
          password: postgres
          user: postgres
          name: determined
        checkpoint_storage:
          type: shared_fs
          host_path: /lus/scratch/foundation_engineering/determined-cp 
        log:
          level: debug
        resource_manager:
          master_host: casablanca-login.us.cray.com
          master_port: 8082
          security:
             tls:
                skip_verify: true
          host: casablanca-login.us.cray.com
          port: 8043
          protocol: https
          type: slurm
          # Type of slot to be allocated by the SLURM scheduler.
          # Default is gpu-based allocation (cuda/rocm), but this requires SLURM to be
          # configure with SelectType=select/cons_tres.   For systems without this
          # Specify cpu, and add contraints to ensure select node have GPUs if desired.
          slot_type: cuda
          # File containing the authorization token for communication with the launcher -- if blank then none.
          # This would typically be a full path where the determined master is running generated by 
          # the `dev-keytool token` command.
          # If using devcluster relative to the directory from which it was invoked (typically determined-ee).
          auth_file:
          # Specify per-partition overrides for submitted tasks.
          # partition_overrides:
          #   defq:
          #     rendezvous_network_interface: eth0
          #     task_container_defaults:
          #       dtrain_network_interface: ib0
          #       force_pull_image: true

        # This is important: we have to use the symbolic links in the
        # tools/build directory to run properly.
        root: tools/build

