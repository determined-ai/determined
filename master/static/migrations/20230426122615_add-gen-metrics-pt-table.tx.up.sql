/*
starting state:

determined> \d raw_steps;
+---------------+--------------------------+---------------------------------------------------------+
| Column        | Type                     | Modifiers                                               |
|---------------+--------------------------+---------------------------------------------------------|
| trial_id      | integer                  |  not null                                               |
| end_time      | timestamp with time zone |                                                         |
| metrics       | jsonb                    |                                                         |
| total_batches | integer                  |  not null default 0                                     |
| trial_run_id  | integer                  |  not null default 0                                     |
| archived      | boolean                  |  not null default false                                 |
| id            | integer                  |  not null default nextval('raw_steps_id_seq'::regclass) |
+---------------+--------------------------+---------------------------------------------------------+
Indexes:
    "steps_trial_id_total_batches_run_id_unique" UNIQUE, btree (trial_id, total_batches, trial_run_id)
    "steps_archived" btree (archived)
Foreign-key constraints:
    "steps_trial_id_fkey" FOREIGN KEY (trial_id) REFERENCES trials(id)

determined> \d raw_validations;
+---------------+--------------------------+--------------------------------------------+
| Column        | Type                     | Modifiers                                  |
|---------------+--------------------------+--------------------------------------------|
| id            | integer                  |  not null generated by default as identity |
| trial_id      | integer                  |  not null                                  |
| end_time      | timestamp with time zone |                                            |
| metrics       | jsonb                    |                                            |
| total_batches | integer                  |  not null default 0                        |
| trial_run_id  | integer                  |  not null default 0                        |
| archived      | boolean                  |  not null default false                    |
+---------------+--------------------------+--------------------------------------------+
Indexes:
    "validations_pkey" PRIMARY KEY, btree (id)
    "validations_trial_id_total_batches_run_id_unique" UNIQUE, btree (trial_id, total_batches, trial_run_id)
    "ix_validations_trial_id" btree (trial_id)
    "validations_archived" btree (archived)
Referenced by:
    TABLE "trials" CONSTRAINT "trials_latest_validation_id_fkey" FOREIGN KEY (latest_validation_id) REFERENCES raw_validations(id) ON DELETE SET NULL
Triggers:
    autoupdate_exp_validation_metrics_name AFTER INSERT ON raw_validations FOR EACH ROW EXECUTE PROCEDURE autoupdate_exp_validation_metrics_name()

determined>
*/


CREATE TYPE metric_type AS ENUM ('validation', 'training', 'generic');

ALTER TABLE raw_validations ADD COLUMN type metric_type NOT NULL DEFAULT 'validation';
ALTER INDEX validations_trial_id_total_batches_run_id_unique RENAME TO validations_trial_id_total_batches_run_id_unique_old;
CREATE UNIQUE INDEX validations_trial_id_total_batches_run_id_type_unique ON raw_validations (
    trial_id, total_batches, trial_run_id, type -- CHECK: safe to use `type` as the name?
);
DROP INDEX validations_trial_id_total_batches_run_id_unique_old;

ALTER TABLE raw_steps ADD COLUMN type metric_type NOT NULL DEFAULT 'training';
ALTER INDEX steps_trial_id_total_batches_run_id_unique RENAME TO steps_trial_id_total_batches_run_id_unique_old;
CREATE UNIQUE INDEX steps_trial_id_total_batches_run_id_type_unique ON raw_steps (
    trial_id, total_batches, trial_run_id, type
);
DROP INDEX steps_trial_id_total_batches_run_id_unique_old;


CREATE SEQUENCE generic_metrics_id_seq START WITH 1;
CREATE TABLE generic_metrics (
    trial_id integer NOT NULL,
    end_time timestamp with time zone,
    metrics jsonb,
    total_batches integer NOT NULL DEFAULT 0,
    trial_run_id integer NOT NULL DEFAULT 0,
    archived boolean NOT NULL DEFAULT false,
    id integer NOT NULL DEFAULT nextval('generic_metrics_id_seq'),
    type metric_type NOT NULL DEFAULT 'generic',
    CONSTRAINT generic_metrics_trial_id_fkey FOREIGN KEY (trial_id) REFERENCES trials(id)
);


CREATE TABLE metrics (
    trial_id integer NOT NULL,
    end_time timestamp with time zone,
    metrics jsonb,
    total_batches integer NOT NULL DEFAULT 0,
    trial_run_id integer NOT NULL DEFAULT 0,
    archived boolean NOT NULL DEFAULT false,
    id integer NOT NULL,
    type metric_type NOT NULL DEFAULT 'generic'
    -- CONSTRAINT metrics_trial_id_fkey FOREIGN KEY (trial_id) REFERENCES trials(id). Not supported
) PARTITION BY LIST (type);

ALTER TABLE metrics ATTACH PARTITION generic_metrics FOR VALUES IN ('generic');
ALTER TABLE metrics ATTACH PARTITION raw_validations FOR VALUES IN (
    'validation'
);
ALTER TABLE metrics ATTACH PARTITION raw_steps FOR VALUES IN ('training');
