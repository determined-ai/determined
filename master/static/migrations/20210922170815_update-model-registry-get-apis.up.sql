CREATE TABLE public.modelsv2 (
	id integer NOT NULL,
	name character varying UNIQUE NOT NULL,
	description character varying,
	metadata jsonb,
	creation_time timestamp with time zone NOT NULL,
	last_updated_time timestamp with time zone,
    num_versions integer DEFAULT 0 NOT NULL,
    labels text[],
    readme text,
    username text,
    archived boolean DEFAULT false NOT NULL,

	CONSTRAINT modelsv2_pkey PRIMARY KEY (id)
);

ALTER TABLE public.modelsv2 ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.models_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);

CREATE TABLE public.model_versionsv2 (
	version integer NOT NULL,
	model integer NOT NULL REFERENCES public.modelsv2(id),
	checkpoint_uuid uuid NOT NULL,
	creation_time timestamp with time zone NOT NULL,
	last_updated_time timestamp with time zone,
	metadata jsonb,

	CONSTRAINT model_and_version_uniquev2 UNIQUE (model, version),
	CONSTRAINT model_versionsv2_pkey PRIMARY KEY (model, version),
	FOREIGN KEY(checkpoint_uuid) REFERENCES public.checkpoints(uuid)
);

INSERT INTO public.modelsv2(id, name, description, metadata, creation_time, last_updated_time) SELECT nextval('public.models_id_seq'), name, description, metadata, creation_time, last_updated_time FROM public.models;

WITH id_name_map as (
    SELECT mv.version, m.id, mv.checkpoint_uuid, mv.creation_time, mv.last_updated_time, mv.metadata 
    FROM public.modelsv2 as m
    JOIN public.model_versions as mv on mv.model_name = m.name
)
INSERT INTO public.model_versionsv2 SELECT * FROM id_name_map;

DROP TABLE public.models CASCADE;

DROP TABLE public.model_versions CASCADE;

ALTER TABLE public.modelsv2
RENAME TO models;

ALTER TABLE public.model_versionsv2
RENAME TO model_versions;
