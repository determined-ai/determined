package internal

import (
	"testing"

	"github.com/stretchr/testify/require"
)

func TestShimExperimentSnapshotV4(t *testing.T) {
	//nolint:lll // Much more readable this way, than a hundreds of lines of formatted JSON.
	snapshot := []byte(`{"searcher_state": {"rand": {"key": [2970094109, 656686882, 618108684, 3428065983, 3347811667, 2888225350, 3059306387, 3429410465, 120474970, 2272301777, 985108865, 991558874, 3272543769, 1573748485, 942809215, 3888215743, 2210951765, 1718115507, 3963921664, 3557444060, 1499923783, 1829703377, 750493200, 3411092685, 589595500, 2596144409, 1879328096, 1280550458, 2715466210, 2544141428, 1543312021, 2997818084, 765128503, 536629897, 1001278031, 956821445, 2736363088, 947342293, 3898485884, 3425929255, 356849665, 3772908806, 3623557158, 2612581302, 3580922597, 217692149, 2059015628, 2096894728, 1031554394, 2656443257, 856730792, 2596152358, 3710976744, 3544672276, 1734608805, 481137749, 969621572, 754645566, 4116998116, 79516852, 3779707014, 84449565, 2299776967, 3049981717, 209980308, 730595889, 475796649, 176283770, 945344397, 3533051341, 1815446302, 3773966474, 2608085762, 3988702430, 1364580973, 954047394, 3612132653, 772541827, 644272441, 189803165, 931375382, 345347493, 1070927534, 1233280688, 2977342360, 964860546, 311939975, 4227569059, 1111154497, 2670796852, 2936307495, 1340846895, 2187526044, 4049656992, 2523649560, 3366534695, 4129435744, 2210183795, 1260247727, 3172172609, 845427714, 2412303263, 4029524955, 496281340, 1521525374, 1068147028, 715985502, 4093783277, 2159512480, 133552717, 436985375, 3034348399, 1875037974, 4060219881, 2429216519, 1706838315, 3704003030, 1782549491, 3768045061, 3989593374, 93865362, 1767865857, 1137597591, 252302268, 3084248212, 619916972, 4054361685, 2046158286, 1812194877, 3286982519, 3624326839, 2208625006, 3161233673, 3006516503, 2024883981, 1656495788, 587227161, 3021529118, 3172394998, 3398906615, 615744671, 3472224112, 212954520, 1118562041, 1921307781, 1197366600, 1484195533, 1200554730, 729716373, 1652264122, 1007315030, 2434524607, 585522965, 1141433277, 278327678, 3497727325, 356102370, 1394639384, 1857470125, 735035053, 2157227949, 2119739569, 171894210, 839804861, 1047866560, 420010537, 1667233883, 352520083, 1757099499, 2384088069, 251603325, 4218299275, 3730818711, 1003235663, 299940149, 2645812204, 2480727500, 1622974487, 1629312940, 3982198086, 2956489407, 2625953102, 1319536795, 42594099, 1983096735, 973960638, 3621842015, 3277003271, 2353057652, 181048897, 971058611, 596055263, 916085615, 181371615, 1523808158, 1627674241, 1944135612, 1287953114, 427398813, 3657156653, 2038254583, 1728892774, 2979810975, 1203810426, 870115982, 2342890482, 239526972, 161374077, 1298609642, 3361627384, 1120507760, 2857852335, 1817591908, 2278524994, 2381282828, 390752450, 2583666345, 2894166573, 1090621184, 1216468230, 2471775878, 4007164892, 4120390730, 2245347208, 1747432849, 2659194233, 3123421709, 1394627981, 3642599365, 447037831, 2948358439, 2071590290, 620060883, 1189294322, 865221550, 1072574172, 4239383229, 3932654708, 977824870, 4090083517, 996564545, 2215368799, 1639088756, 1063294874, 2589869379, 2931882145, 1119478531, 2913543435, 2863960600, 2220278034, 1514566588, 2171894117, 1040890154, 613591648, 4213726618, 3733950164, 3557521554, 451572785, 1963683489, 2910238750, 1724590625, 2276900333, 2786477774, 194531157, 2427295372, 2668452276, 3024832162, 4118825874, 2048453723, 602839057, 1287626269, 391207769, 1490752784, 631791025, 3012581026, 2165558496, 711793093, 394391602, 3030359078, 753489044, 1912791312, 805796394, 3405161241, 2387156388, 3012369288, 785079410, 1579291678, 2186594177, 1466653116, 2597054161, 2032480878, 2608593331, 245623596, 4030340391, 4102274438, 1820069747, 861878589, 1987396926, 1234162528, 4203068184, 4247911765, 675763300, 776602741, 2725860139, 1101969549, 2417348663, 3640520171, 4117232477, 1498968755, 1465742592, 978609897, 207663660, 3872867123, 2345883885, 3859129626, 2085742042, 2849699660, 766128209, 1220321488, 4036832842, 2625520262, 1672441713, 68307500, 1664835655, 4277760737, 2834495524, 1659112114, 4058377674, 3503936154, 3460939589, 1534417391, 546891454, 2119405354, 1342659996, 4063240713, 2470735676, 4263599371, 1004146457, 4110714736, 161171862, 3755105332, 2045654769, 3373580076, 3804959282, 172165195, 1513507373, 756508282, 2395802730, 1042880862, 424954450, 3528754016, 705074650, 1657675167, 3512260741, 1502017722, 3914739402, 2193244645, 2422500613, 99094108, 2136256596, 2765564582, 1469408647, 422762387, 4256532504, 2587902689, 322034733, 869598360, 1591826706, 3537194108, 432319981, 3238387140, 3998122956, 1638675667, 2820632381, 2704736212, 1001829652, 3842914244, 2163956861, 1247332102, 4161816793, 1047179830, 3332934466, 3373357404, 1755466786, 2066857771, 3041960543, 1984594045, 2873866111, 625922821, 2084260334, 647387503, 1795267011, 2734649093, 1429118207, 1763491842, 2499417212, 1322753865, 2546278618, 3069808828, 2758040961, 2095345089, 1117531393, 1079149953, 199028389, 5727143, 2626507809, 1394644924, 2371859674, 3378009021, 663183580, 1964126253, 4253076758, 1951862122, 3318205484, 246506769, 2065283265, 4062893977, 1357669276, 1910189941, 1768248614, 2642642591, 3082965658, 2821926795, 3387815148, 3811042618, 47443245, 1219528119, 2554982004, 3265451419, 2888244446, 4219157977, 970880074, 1607338684, 3191412771, 2649941819, 3075671217, 1402753481, 4075173340, 1295557797, 911791588, 847594689, 2359505701, 3661496760, 733404895, 249867897, 1640333750, 582965187, 1381547711, 2657453162, 1011026771, 2180307770, 52701968, 2169192963, 3746362727, 509530176, 4097693696, 406641367, 2522117714, 2016171603, 2069773173, 3084060900, 1332397153, 1412022588, 1875059352, 3676296777, 3375212542, 1306176142, 133024327, 2608708004, 139194617, 519502757, 1353538952, 3608390217, 3046145872, 1399364698, 4125351745, 572217286, 2142672378, 2889903141, 3434412210, 2393320012, 3956475466, 562179437, 3542566562, 3807446953, 1580557399, 3614175239, 3960865405, 3703717660, 2310530500, 1372501162, 3987983520, 2273295537, 3041676882, 1184238826, 1347025024, 1978741180, 1085872423, 3721856454, 4017856803, 3452381717, 2476724512, 3844971453, 3783643616, 1806640004, 945069700, 146817685, 3591154906, 3316795159, 3055211927, 3538095801, 2794589177, 2749831736, 3448467389, 2625023521, 183144251, 1181880302, 2668701387, 1211953638, 2740205019, 1424192308, 3005227360, 3518579311, 2030094765, 2163439322, 528876425, 713989960, 49680970, 3843683734, 2284197334, 754118913, 3660862775, 2811591585, 1900142815, 909665247, 3587945731, 1738555018, 4017103008, 363980482, 3596395463, 4036688775, 562009149, 652191781, 3255386890, 742878000, 9948449, 1293599923, 3198724758, 1824688996, 971993200, 545911088, 3111974979, 548678661, 3540201872, 347949716, 3899497825, 3919059349, 4023520489, 3906867502, 2926287461, 1975024135, 1961216548, 4241655703, 882861834, 447828602, 1073917811, 3204969134, 3637120523, 2561353660, 3087651888, 2625085299, 3045978593, 3296945077, 3353240266, 264317791, 3618427144, 3041663648, 3129441565, 1614617882, 742204376, 107307162, 4015043056, 164246162, 2971078786, 3420066832, 1704293461, 459244372, 744914593, 710366705, 2599447851, 3652089701, 712803605, 2980013293, 476563708, 1665840194, 1037190002, 3225477896, 1430942116, 2632665368, 3730881422, 1625879865, 363179597, 3829523707, 14110766, 1150504976, 2891936857, 256611346, 774302498, 184441060, 803067320, 3354307461, 2067530913, 466995748, 1177075098, 4068208859, 1923629384, 3949860772, 3830641659, 1017128665, 2972991357, 4238922926, 575232160, 101928834, 2405116568], "pos": 5}, "exits": {}, "failures": {}, "shutdown": false, "trials_closed": {}, "trial_progress": {"bb239c3a-c6b5-4ef3-ba7b-118038bd0d06": 0}, "trials_created": {"bb239c3a-c6b5-4ef3-ba7b-118038bd0d06": true}, "trials_requested": 1, "search_method_state": {"created_trials": 1, "pending_trials": 1, "search_method_type": "single"}, "completed_operations": {}}, "trial_searcher_state": {"bb239c3a-c6b5-4ef3-ba7b-118038bd0d06": {"Op": {"Length": {"batches": 937}, "RequestID": "bb239c3a-c6b5-4ef3-ba7b-118038bd0d06"}, "Closed": true, "Create": {"hparams": {"dropout1": 0.25, "dropout2": 0.5, "n_filters1": 32, "n_filters2": 64, "learning_rate": 1, "global_batch_size": 64}, "checkpoint": null, "request_id": "bb239c3a-c6b5-4ef3-ba7b-118038bd0d06", "trial_seed": 1757369869, "workload_sequencer_type": "TRIAL_WORKLOAD_SEQUENCER"}, "Complete": false}}}`)
	//nolint:lll // Same.
	newSnapshot := []byte(`{"searcher_state": {"rand": {"key": [2970094109, 656686882, 618108684, 3428065983, 3347811667, 2888225350, 3059306387, 3429410465, 120474970, 2272301777, 985108865, 991558874, 3272543769, 1573748485, 942809215, 3888215743, 2210951765, 1718115507, 3963921664, 3557444060, 1499923783, 1829703377, 750493200, 3411092685, 589595500, 2596144409, 1879328096, 1280550458, 2715466210, 2544141428, 1543312021, 2997818084, 765128503, 536629897, 1001278031, 956821445, 2736363088, 947342293, 3898485884, 3425929255, 356849665, 3772908806, 3623557158, 2612581302, 3580922597, 217692149, 2059015628, 2096894728, 1031554394, 2656443257, 856730792, 2596152358, 3710976744, 3544672276, 1734608805, 481137749, 969621572, 754645566, 4116998116, 79516852, 3779707014, 84449565, 2299776967, 3049981717, 209980308, 730595889, 475796649, 176283770, 945344397, 3533051341, 1815446302, 3773966474, 2608085762, 3988702430, 1364580973, 954047394, 3612132653, 772541827, 644272441, 189803165, 931375382, 345347493, 1070927534, 1233280688, 2977342360, 964860546, 311939975, 4227569059, 1111154497, 2670796852, 2936307495, 1340846895, 2187526044, 4049656992, 2523649560, 3366534695, 4129435744, 2210183795, 1260247727, 3172172609, 845427714, 2412303263, 4029524955, 496281340, 1521525374, 1068147028, 715985502, 4093783277, 2159512480, 133552717, 436985375, 3034348399, 1875037974, 4060219881, 2429216519, 1706838315, 3704003030, 1782549491, 3768045061, 3989593374, 93865362, 1767865857, 1137597591, 252302268, 3084248212, 619916972, 4054361685, 2046158286, 1812194877, 3286982519, 3624326839, 2208625006, 3161233673, 3006516503, 2024883981, 1656495788, 587227161, 3021529118, 3172394998, 3398906615, 615744671, 3472224112, 212954520, 1118562041, 1921307781, 1197366600, 1484195533, 1200554730, 729716373, 1652264122, 1007315030, 2434524607, 585522965, 1141433277, 278327678, 3497727325, 356102370, 1394639384, 1857470125, 735035053, 2157227949, 2119739569, 171894210, 839804861, 1047866560, 420010537, 1667233883, 352520083, 1757099499, 2384088069, 251603325, 4218299275, 3730818711, 1003235663, 299940149, 2645812204, 2480727500, 1622974487, 1629312940, 3982198086, 2956489407, 2625953102, 1319536795, 42594099, 1983096735, 973960638, 3621842015, 3277003271, 2353057652, 181048897, 971058611, 596055263, 916085615, 181371615, 1523808158, 1627674241, 1944135612, 1287953114, 427398813, 3657156653, 2038254583, 1728892774, 2979810975, 1203810426, 870115982, 2342890482, 239526972, 161374077, 1298609642, 3361627384, 1120507760, 2857852335, 1817591908, 2278524994, 2381282828, 390752450, 2583666345, 2894166573, 1090621184, 1216468230, 2471775878, 4007164892, 4120390730, 2245347208, 1747432849, 2659194233, 3123421709, 1394627981, 3642599365, 447037831, 2948358439, 2071590290, 620060883, 1189294322, 865221550, 1072574172, 4239383229, 3932654708, 977824870, 4090083517, 996564545, 2215368799, 1639088756, 1063294874, 2589869379, 2931882145, 1119478531, 2913543435, 2863960600, 2220278034, 1514566588, 2171894117, 1040890154, 613591648, 4213726618, 3733950164, 3557521554, 451572785, 1963683489, 2910238750, 1724590625, 2276900333, 2786477774, 194531157, 2427295372, 2668452276, 3024832162, 4118825874, 2048453723, 602839057, 1287626269, 391207769, 1490752784, 631791025, 3012581026, 2165558496, 711793093, 394391602, 3030359078, 753489044, 1912791312, 805796394, 3405161241, 2387156388, 3012369288, 785079410, 1579291678, 2186594177, 1466653116, 2597054161, 2032480878, 2608593331, 245623596, 4030340391, 4102274438, 1820069747, 861878589, 1987396926, 1234162528, 4203068184, 4247911765, 675763300, 776602741, 2725860139, 1101969549, 2417348663, 3640520171, 4117232477, 1498968755, 1465742592, 978609897, 207663660, 3872867123, 2345883885, 3859129626, 2085742042, 2849699660, 766128209, 1220321488, 4036832842, 2625520262, 1672441713, 68307500, 1664835655, 4277760737, 2834495524, 1659112114, 4058377674, 3503936154, 3460939589, 1534417391, 546891454, 2119405354, 1342659996, 4063240713, 2470735676, 4263599371, 1004146457, 4110714736, 161171862, 3755105332, 2045654769, 3373580076, 3804959282, 172165195, 1513507373, 756508282, 2395802730, 1042880862, 424954450, 3528754016, 705074650, 1657675167, 3512260741, 1502017722, 3914739402, 2193244645, 2422500613, 99094108, 2136256596, 2765564582, 1469408647, 422762387, 4256532504, 2587902689, 322034733, 869598360, 1591826706, 3537194108, 432319981, 3238387140, 3998122956, 1638675667, 2820632381, 2704736212, 1001829652, 3842914244, 2163956861, 1247332102, 4161816793, 1047179830, 3332934466, 3373357404, 1755466786, 2066857771, 3041960543, 1984594045, 2873866111, 625922821, 2084260334, 647387503, 1795267011, 2734649093, 1429118207, 1763491842, 2499417212, 1322753865, 2546278618, 3069808828, 2758040961, 2095345089, 1117531393, 1079149953, 199028389, 5727143, 2626507809, 1394644924, 2371859674, 3378009021, 663183580, 1964126253, 4253076758, 1951862122, 3318205484, 246506769, 2065283265, 4062893977, 1357669276, 1910189941, 1768248614, 2642642591, 3082965658, 2821926795, 3387815148, 3811042618, 47443245, 1219528119, 2554982004, 3265451419, 2888244446, 4219157977, 970880074, 1607338684, 3191412771, 2649941819, 3075671217, 1402753481, 4075173340, 1295557797, 911791588, 847594689, 2359505701, 3661496760, 733404895, 249867897, 1640333750, 582965187, 1381547711, 2657453162, 1011026771, 2180307770, 52701968, 2169192963, 3746362727, 509530176, 4097693696, 406641367, 2522117714, 2016171603, 2069773173, 3084060900, 1332397153, 1412022588, 1875059352, 3676296777, 3375212542, 1306176142, 133024327, 2608708004, 139194617, 519502757, 1353538952, 3608390217, 3046145872, 1399364698, 4125351745, 572217286, 2142672378, 2889903141, 3434412210, 2393320012, 3956475466, 562179437, 3542566562, 3807446953, 1580557399, 3614175239, 3960865405, 3703717660, 2310530500, 1372501162, 3987983520, 2273295537, 3041676882, 1184238826, 1347025024, 1978741180, 1085872423, 3721856454, 4017856803, 3452381717, 2476724512, 3844971453, 3783643616, 1806640004, 945069700, 146817685, 3591154906, 3316795159, 3055211927, 3538095801, 2794589177, 2749831736, 3448467389, 2625023521, 183144251, 1181880302, 2668701387, 1211953638, 2740205019, 1424192308, 3005227360, 3518579311, 2030094765, 2163439322, 528876425, 713989960, 49680970, 3843683734, 2284197334, 754118913, 3660862775, 2811591585, 1900142815, 909665247, 3587945731, 1738555018, 4017103008, 363980482, 3596395463, 4036688775, 562009149, 652191781, 3255386890, 742878000, 9948449, 1293599923, 3198724758, 1824688996, 971993200, 545911088, 3111974979, 548678661, 3540201872, 347949716, 3899497825, 3919059349, 4023520489, 3906867502, 2926287461, 1975024135, 1961216548, 4241655703, 882861834, 447828602, 1073917811, 3204969134, 3637120523, 2561353660, 3087651888, 2625085299, 3045978593, 3296945077, 3353240266, 264317791, 3618427144, 3041663648, 3129441565, 1614617882, 742204376, 107307162, 4015043056, 164246162, 2971078786, 3420066832, 1704293461, 459244372, 744914593, 710366705, 2599447851, 3652089701, 712803605, 2980013293, 476563708, 1665840194, 1037190002, 3225477896, 1430942116, 2632665368, 3730881422, 1625879865, 363179597, 3829523707, 14110766, 1150504976, 2891936857, 256611346, 774302498, 184441060, 803067320, 3354307461, 2067530913, 466995748, 1177075098, 4068208859, 1923629384, 3949860772, 3830641659, 1017128665, 2972991357, 4238922926, 575232160, 101928834, 2405116568], "pos": 5}, "exits": {}, "failures": {}, "shutdown": false, "trials_closed": {}, "trial_progress": {"bb239c3a-c6b5-4ef3-ba7b-118038bd0d06": 0}, "trials_created": {"bb239c3a-c6b5-4ef3-ba7b-118038bd0d06": true}, "trials_requested": 1, "search_method_state": {"created_trials": 1, "pending_trials": 1, "search_method_type": "single"}, "completed_operations": {}}, "trial_searcher_state": {"bb239c3a-c6b5-4ef3-ba7b-118038bd0d06": {"Op": {"Length": 937, "RequestID": "bb239c3a-c6b5-4ef3-ba7b-118038bd0d06"}, "Closed": true, "Create": {"hparams": {"dropout1": 0.25, "dropout2": 0.5, "n_filters1": 32, "n_filters2": 64, "learning_rate": 1, "global_batch_size": 64}, "checkpoint": null, "request_id": "bb239c3a-c6b5-4ef3-ba7b-118038bd0d06", "trial_seed": 1757369869, "workload_sequencer_type": "TRIAL_WORKLOAD_SEQUENCER"}, "Complete": false}}}`)
	actual, err := shimExperimentSnapshotV4(snapshot)
	require.NoError(t, err)
	require.JSONEq(t, string(newSnapshot), string(actual))
}
